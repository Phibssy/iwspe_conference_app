@page "/admin"
@using Microsoft.AspNetCore.Authorization
@using System.Text.Json
@attribute [Authorize]
@inject Conference.Client.Services.ApiService Api
@inject NavigationManager Nav

<h1>Admin Dashboard</h1>
<p>This view is protected by Azure AD.</p>

<h3>Registration Fields</h3>
<ul>
  <li><strong>Name</strong> (required)</li>
  <li><strong>Email</strong> (required)</li>
  <li><strong>Affiliation</strong> (required; e.g., university)</li>
  <li><strong>Phone</strong> (optional)</li>
  <li><strong>Selected events</strong> (array of event IDs)</li>
</ul>

<div class="button-group">
    <button class="btn btn-primary" @onclick="LoadRegistrations">Load Registrations</button>
    <button class="btn btn-secondary" @onclick="NavigateToWaitlist">Open Waitlist Manager</button>
</div>

@if (loading)
{
    <p>Loadingâ€¦</p>
}
else if (!string.IsNullOrEmpty(error))
{
    <p style="color:red">Error: @error</p>
}
else if (regs != null && regs.Count > 0)
{
    <h4>Registrations (@regs.Count)</h4>
    <table class="table">
        <thead>
            <tr>
                <th>Name</th>
                <th>Email</th>
                <th>Affiliation</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var r in regs)
            {
                <tr>
                    <td>@r.Name</td>
                    <td>@r.Email</td>
                    <td>@r.Affiliation</td>
                </tr>
            }
        </tbody>
    </table>
}

@code {
    private bool loading = false;
    private string? error;
    private List<RegistrationDto>? regs;

    private void NavigateToWaitlist() => Nav.NavigateTo("/admin/waitlist");

    private async Task LoadRegistrations()
    {
        loading = true;
        error = null;
        try
        {
            var resp = await Api.GetRegistrationsAsync();
            if (!resp.IsSuccessStatusCode)
            {
                error = $"Server returned {(int)resp.StatusCode} {resp.ReasonPhrase}";
            }
            else
            {
                var json = await resp.Content.ReadAsStringAsync();
                regs = JsonSerializer.Deserialize<List<RegistrationDto>>(json, 
                    new JsonSerializerOptions { PropertyNameCaseInsensitive = true });
            }
        }
        catch (Exception ex)
        {
            error = ex.Message;
        }
        finally
        {
            loading = false;
        }
    }

    private class RegistrationDto 
    { 
        public string? Id { get; set; }
        public string? Name { get; set; } 
        public string? Email { get; set; } 
        public string? Affiliation { get; set; } 
    }
}
